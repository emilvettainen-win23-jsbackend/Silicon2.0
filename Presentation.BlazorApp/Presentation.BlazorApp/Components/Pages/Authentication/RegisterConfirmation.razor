@page "/account/registerconfirmation"
@using BlazorBootstrap
@using Microsoft.AspNetCore.WebUtilities
@using Newtonsoft.Json
@using Presentation.BlazorApp.Components.Shared
@using System.ComponentModel.DataAnnotations



<PageTitle>Register confirmation</PageTitle>





<section id="confirmation">
    <div class="container">
        <EditForm Model="VerifyForm" asp-route-returnUrl="@ReturnUrl" method="post" OnValidSubmit="VerifyAsync" FormName="RegisterConfirmation" Enhance novalidate>
            <DataAnnotationsValidator />

            @if (Notification != null)
            {
            <div class="alert alert-@Notification.Icon" role="alert">
            @Notification.Message
            </div>
            }


            <div class="content">
                <div id="form-info">
                    <h1>Verify your account</h1>
                    <p>Check your email for a verification code to complete your registration.</p>
                    <ResendButton Email="@Email" @rendermode="InteractiveServer" />
                </div>
                <div id="form-code" class="input-group">
                    <label for="code">Code</label>
                    <InputText id="code" @bind-Value="VerifyForm.Code" class="form-control" autocomplete="off" placeholder="Enter your verification code" />
                    <ValidationMessage For="() => VerifyForm.Code" class="text-danger" />
                </div>
                <button disabled="@IsBusy" id="form-submit" class="btn-theme-large" type="submit">
                    @if (IsBusy)
                    {
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    }
                    <span id="button-text">Confirm</span>
                </button>
            </div>
        </EditForm>
    </div>
</section>



@code {

    private bool IsBusy;

    private ApplicationUser user = default!;


    [SupplyParameterFromQuery]
    private string? Email { get; set; }


    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }


    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;


    [SupplyParameterFromForm]
    private VerifyRegistrationModel VerifyForm { get; set; } = new();

    private ExternalLoginInfo externalLoginInfo = default!;

    private AlertModel? Notification { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Email is null)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        var currentUser = await UserManager.FindByEmailAsync(Email);
        if (currentUser is not null)
        {
            user = currentUser;

        }
        // var info = await SignInManager.GetExternalLoginInfoAsync();
        // if (info is null)
        // {
        //     // RedirectManager.RedirectToWithStatus("Account/Login", "Error loading external login information.", HttpContext);
        // }
        // externalLoginInfo = info;

        // var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        // if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("message", out var jsonMessage))
        // {
        //     // Deserialisera JSON-strängen till en MessageModel
        //     Message = JsonConvert.DeserializeObject<MessageModel>(jsonMessage!);
        // }


       
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Swal.FireAsync("helloworld");
        }
    }




    // private MessageModel? Message { get; set; }

    private async Task VerifyAsync()
    {
        var result = await Http.PostAsJsonAsync($"{Config["URI:ValidateCode"]}", new { Email = Email, Code = VerifyForm.Code });
        if (result.IsSuccessStatusCode)
        {
            user.EmailConfirmed = true;
            var updateResult = await UserManager.UpdateAsync(user);
            if (updateResult.Succeeded)
            {

                Notification = new AlertModel
                {
                    Message = "Account verified successfully. You may now proceed to log in.",
                    Icon = "success"
                };


            }
        }
    }


    private async Task ResendCodeAsync()
    {
        try
        {
            var result = await Http.PostAsJsonAsync($"{Config["URI:GenerateCode"]}", new { Email = Email });
            if (result.IsSuccessStatusCode)
            {
                //code resent
            }
            else
            {
                //try again
            }
        }
        catch (Exception)
        {
            //contact support
            throw;
        }

    }

    private sealed class VerifyRegistrationModel
    {
        [Required(ErrorMessage = "Verification code is required!")]
        public string Code { get; set; } = null!;
    }


}